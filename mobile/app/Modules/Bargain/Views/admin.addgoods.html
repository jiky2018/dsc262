{include file="admin_pageheader"}
<!--同步pc时间插件修改-->
<link href="../js/calendar/calendar.min.css" rel="stylesheet" type="text/css" />
<script src="../js/calendar/calendar.min.js"></script><!--时间插件js-->
<style>
ul, li {overflow: hidden;}
.dates_box_top {height: 32px;}
.dates_bottom {height: auto;}
.dates_hms {width: auto;}
.dates_btn {width: auto;}
.dates_mm_list span {width: auto;}
</style>
<!--同步pc时间插件修改 end-->
<style>
.checkbox_item-box{display: none;}
.checkbox_item-box.active{display: block}

.goods_price{display: none;}
.goods_price.active{display: block}

.target_price{display: none;}
.target_price.active{display: block}

</style>
<div class="wrapper">
    <div class="title">砍价 - 添加砍价商品</div>
    <div class="content_tips">
        <div class="explanation" id="explanation">
            <div class="ex_tit"><i class="sc_icon"></i><h4>操作提示</h4><span id="explanationZoom" title="收起提示"></span></div>
            <ul>
               	<li>管理员可以在此页添加砍价的商品。</li>
                <li>该砍价商品活动结束之前，不可添加新的活动。</li>
            </ul>
        </div>
        <div class="flexilist">
            <div class="main-info">

                <form method="post" action="{url('addgoods')}" enctype="multipart/form-data" role="form" id="group_buy_form" class="validation" >
                <div class="switch_info">
                	<!--搜索-->
	            	<div class="goods_search_div bor_bt_das">
                        <div class="search_select">
                            <div class="categorySelect">
	                            <div class="selection">
	                                <input type="text" name="category_name" id="category_name" class="text w250 valid" value="请选择分类" autocomplete="off" readonly="" data-filter="cat_name">
	                                <input type="hidden" name="category_id" id="category_id" value="0" data-filter="cat_id">
	                            </div>
                                <div class="select-container" style="display: none;">
                                	<!--分类搜索-->
                                    <!-- {include file="filter_team_category"} -->
                                    <div class="select-top">
                                        <a href="javascript:;" class="categoryTop" data-cid="0" data-cname="">重选</a>
                                        {if $filter_category_navigation}
                                        {foreach from=$filter_category_navigation item=navigation}
                                            &gt;<a href="javascript:;" class="categoryTop" data-cid="{$navigation.cat_id}" data-cname="{$navigation.cat_name}">{$navigation.cat_name}</a>
                                        {/foreach}
                                        {else}
                                        &gt; <span>请选择分类</span>
                                        {/if}
                                    </div>
                                    <div class="select-list">
                                        <ul>
                                            {foreach $filter_category_list as $category}
                                            <li data-cid="{$category.cat_id}" data-cname="{$category.cat_name}"><em>{if $filter_category_level == 1}Ⅰ{elseif $filter_category_level == 2}Ⅱ{elseif $filter_category_level == 3}Ⅲ{else}Ⅰ{/if}</em>{$category.cat_name}</li>
                                            {/foreach}
                                        </ul>
                                    </div>
                                    <!--分类搜索-->
								</div>
                			</div>
                        </div>
                        <div class="search_select">
                            <div class="brandSelect">
                                <div class="selection">
                                    <input type="text" name="brand_name" id="brand_name" class="text w120 valid" value="请选择品牌" autocomplete="off" readonly="" data-filter="brand_name">
                                    <input type="hidden" name="brand_id" id="brand_id" value="0" data-filter="brand_id">
                                </div>
                                <div class="brand-select-container" style="display: none;">
                                    <div class="brand-top">
										<div class="letter">
											<ul>
												<li><a href="javascript:void(0);" data-letter="">全部品牌</a></li>
												<li><a href="javascript:void(0);" data-letter="A">A</a></li>
												<li><a href="javascript:void(0);" data-letter="B">B</a></li>
												<li><a href="javascript:void(0);" data-letter="C">C</a></li>
												<li><a href="javascript:void(0);" data-letter="D">D</a></li>
												<li><a href="javascript:void(0);" data-letter="E">E</a></li>
												<li><a href="javascript:void(0);" data-letter="F">F</a></li>
												<li><a href="javascript:void(0);" data-letter="G">G</a></li>
												<li><a href="javascript:void(0);" data-letter="H">H</a></li>
												<li><a href="javascript:void(0);" data-letter="I">I</a></li>
												<li><a href="javascript:void(0);" data-letter="J">J</a></li>
												<li><a href="javascript:void(0);" data-letter="K">K</a></li>
												<li><a href="javascript:void(0);" data-letter="M">M</a></li>
												<li><a href="javascript:void(0);" data-letter="N">N</a></li>
												<li><a href="javascript:void(0);" data-letter="O">O</a></li>
												<li><a href="javascript:void(0);" data-letter="P">P</a></li>
												<li><a href="javascript:void(0);" data-letter="Q">Q</a></li>
												<li><a href="javascript:void(0);" data-letter="R">R</a></li>
												<li><a href="javascript:void(0);" data-letter="S">S</a></li>
												<li><a href="javascript:void(0);" data-letter="T">T</a></li>
												<li><a href="javascript:void(0);" data-letter="U">U</a></li>
												<li><a href="javascript:void(0);" data-letter="V">V</a></li>
												<li><a href="javascript:void(0);" data-letter="W">W</a></li>
												<li><a href="javascript:void(0);" data-letter="X">X</a></li>
												<li><a href="javascript:void(0);" data-letter="Y">Y</a></li>
												<li><a href="javascript:void(0);" data-letter="Z">Z</a></li>
												<li><a href="javascript:void(0);" data-letter="QT">其他</a></li>
											</ul>
										</div>
										<div class="b_search">
											<input name="search_brand_keyword" id="search_brand_keyword" type="text" class="b_text" placeholder="品牌名称关键字查找" autocomplete="off">
											<a href="javascript:void(0);" class="btn-mini"><i class="fa fa-search"></i></a>
										</div>
									</div>
									<div class="brand-list ps-container ps-active-y">


                                        <!--品牌搜索-->
                                        <ul>
                                            <li data-id="0" data-name="请选择品牌" class="blue">取消选择</li>
                                            {foreach $filter_brand_list as $brand}
                                            <li data-id="{$brand.brand_id}" data-name="{$brand.brand_name}"><em>{$brand.letter}</em>{$brand.brand_name}</li>
                                            {/foreach}
                                        </ul>
                                        <!--品牌搜索-->

										<div class="ps-scrollbar-x-rail" style="width: 234px; display: none; left: 0px; bottom: 3px;">
											<div class="ps-scrollbar-x" style="left: 0px; width: 0px;"></div>
										</div>
										<div class="ps-scrollbar-y-rail" style="top: 0px; height: 220px; display: inherit; right: 3px;">
											<div class="ps-scrollbar-y" style="top: 0px; height: 13px;"></div>
										</div>
									</div>
										<div class="brand-not" style="display:none;">没有符合"<strong>其他</strong>"条件的品牌</div>
								</div>
                            </div>
                        </div>
                        <input type="hidden" name="ru_id" value="0">
                        <input type="text" name="keyword" class="text w150" placeholder="请输入关键字" data-filter="keyword" autocomplete="off">
                        <a href="javascript:void(0);" class="btn btn30" onclick="searchGoods()"><i class="fa fa-search"></i>搜索</a>
                    </div>
			        <div class="item">
                    	<div class="label-t">砍价商品</div>
                    	<div class="label_value">
                       		<div id="goods_id" class="imitate_select select_w320">
                                <div class="cite">{if $info.id}{$info.goods_name}{else}请选择{/if}</div>
                                <ul>
                                	{if !$info.id}<li class="li_not">请先搜索商品</li>{/if}
                                </ul>
                                <input name="data[goods_id]" type="hidden" datatype="*" nullmsg="请选择拼团商品" value="{if $info.id}{$info.goods_id}{/if}" id="goods_id_val">
                            </div>
                            <div class="form_prompt"></div>
                        </div>
                    </div>
                    <!-- <div class="item " >
                        <div class="label-t">砍价活动标题</div>
                        <div class="label_value">
                            <input type="text" id ="bargain_name" name="data[bargain_name]" datatype="*" nullmsg="请输砍价活动标题" class="text" value="{$info['bargain_name']}">
                            <p class="notic"></p>
                        </div>
                    </div> -->
                    <div class="item goods_price" >
                        <div class="label-t">活动原价</div>
                        <div class="label_value">
                            <input type="text" id ="goods_price" name="data[goods_price]" nullmsg="请输砍价活动原价" class="text" readonly value="{$info['goods_price']}">
                            <p class="notic"></p>
                        </div>
                    </div>
                    <div class="item target_price">
                        <div class="label-t">砍价目标</div>
                        <div class="label_value">
                            <input type="text" id ="target_price" name="data[target_price]" nullmsg="请输砍价目标" class="text" value="{$info['target_price']}">
                            <p class="notic">砍价活动商品最低价</p>
                        </div>
                    </div>
                    <div class="item " >
                        <div class="label-t">开始时间</div>
                        <div class="label_value">
                           <div class="text_time" id="text_time1" style="float:left;">
                                <input type="text" name="data[start_time]" class="text" value="{$info['start_time']}" id="promote_start_date" readonly>
                            </div>


                        </div>
                    </div>

                    <div class="item " >
                        <div class="label-t">结束时间</div>
                        <div class="label_value">
                           <div class="text_time" id="text_time2" style="float:left;">
                                <input type="text" name="data[end_time]" class="text" value="{$info['end_time']}" id="promote_end_date" readonly>
                            </div>
                        </div>
                    </div>
                        <div class="item">
                        <div class="label-t">砍价区间</div>
                        <div class="label_value">
                            <table class="table_div table_heng">
                                <tbody>
                                <tr class="first_tr">
                                    <td><input type="text" name="data[min_price]" value="{$info['min_price']}" class="text new-text w50" autocomplete="off"></td>
                                    <td class="first_td w70">最小值</td>
                                </tr>
                                <tr class="first_tr">
                                    <td><input type="text" name="data[max_price]" value="{$info['max_price']}" class="text new-text w50" autocomplete="off"></td>
                                    <td class="first_td">最大值</td>
                                </tr>
                            </tbody></table>

                            <p class="notic">设置活动每次砍价价格区间，如 1 - 10</p>
                        </div>
                    </div>

                    <!--属性显示-->
                    <div class="item">
                        <div class="label_value " id ="tbody-goodsAttr"></div>
                        <div class="" id ="attribute_table"></div>
                    </div>



                    <div class="item">
                        <div class="label-t">热销活动</div>
                        <div class="label_value">
                            <div class="type-file-box">
                                <div class="checkbox_items">
                                    <div class="checkbox_item">
                                        <input type="radio" name="data[is_hot]"  value="1" {if $info['is_hot']==1}checked{/if}>
                                        <label class="">是</label>
                                    </div>
                                    <div class="checkbox_item">
                                        <input type="radio" name="data[is_hot]"  onclick="tongyianniu();" value="0" {if $info['is_hot']==0}checked{/if}>
                                        <label class="">否</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {if $info['ru_id']}
                    <div class="item">
                        <div class="label-t">审核状态</div>
                        <div class="label_value">
                            <div class="type-file-box">
                                <div class="checkbox_items">
                                    <div class="checkbox_item">
                                        <input type="radio" name="data[is_audit]" class="checkbox_item-1" value="0" {if $info['is_audit']==0}checked{/if}>
                                        <label class="">未审核</label>
                                    </div>
                                    <div class="checkbox_item">
                                        <input type="radio" name="data[is_audit]" class="j-checkbox_item" id="btnRegister" onclick="tongyianniu();" value="1" {if $info['is_audit']==1}checked{/if}>
                                        <label class="">审核未通过</label>
                                    </div>
                                    <div class="checkbox_item">
                                        <input type="radio" name="data[is_audit]" class="checkbox_item-1" value="2" {if $info['is_audit']==2}checked{/if}>
                                        <label class="">审核已通过</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="item checkbox_item-box" >
                        <div class="label-t">审核未通过原因</div>
                        <div class="label_value">
                            <textarea name="data[isnot_aduit_reason]" cols="40" rows="3" class="textarea">{$info['isnot_aduit_reason']}</textarea>
                        </div>
                    </div>
                    {else}
                    <input type="hidden" name="data[is_audit]" value="2" />
                    {/if}
                                        <div class="item">
                        <div class="label-t">&nbsp;</div>
                        <div class="lable_value info_btn">
                            <input type="hidden" name="id" value="{$info['id']}">
                             <input type="hidden" name="bargain_goods_id" value="{$info['goods_id']}">
                            <input type="submit" name="submit" value="确定" class="button" style="margin:0 auto;"></div>
                    </div>
                </div>
                </form>
            </div>
    </div>
</div>

<script>
     //表单验证
    var style_text = "border:none; background: rgba(0,0,0,.7); color:#fff; max-width:90%; min-width:1rem; margin:0 auto; border-radius:.8rem;";
    $(function () {
        $.Tipmsg.r = null;
        $(".validation").Validform({
            tiptype: function (msg) {
                layer.open({
                    style: style_text,
                    type: 0,
                    anim: 3,
                    content: msg,
                    shade: false,
                    time: 2
                })
            },
            tipSweep: true,
            ajaxPost: true,

            callback: function (data) {
                if (data.status === 'y') {
                    window.location.href = data.url;
                } else {
                    layer.open({
                        style: style_text,
                        type: 0,
                        anim: 3,
                        content: data.info,
                        shade: false,
                        time: 2
                    })
                }
            }
        });
    })

    // 大商创PC日历插件sta
    var opts1 = {
        'targetId':'promote_start_date',
        'triggerId':['promote_start_date'],
        'alignId':'text_time1',
        'format':'-',
        'hms':'on',
        'min':'{$info.start_time}' //最小时间
    },opts2 = {
        'targetId':'promote_end_date',
        'triggerId':['promote_end_date'],
        'alignId':'text_time2',
        'format':'-',
        'hms':'on'
        //'min':'{$info.end_time}' //最小时间
    }

    xvDate(opts1);
    xvDate(opts2);
// 大商创PC日历插件end

    $("#explanationZoom").on("click",function(){
        var explanation = $(this).parents(".explanation");
        var width = $(".content_tips").width();
        if($(this).hasClass("shopUp")){
            $(this).removeClass("shopUp");
            $(this).attr("title","收起提示");
            explanation.find(".ex_tit").css("margin-bottom",10);
            explanation.animate({
                width:width
            },300,function(){
                $(".explanation").find("ul").show();
            });
        }else{
            $(this).addClass("shopUp");
            $(this).attr("title","提示相关设置操作时应注意的要点");
            explanation.find(".ex_tit").css("margin-bottom",0);
            explanation.animate({
                width:"118"
            },300);
            explanation.find("ul").hide();
        }
    });

    //未通过理由
    $(function () {
        var is_audit = '{$info.is_audit}';
        if(is_audit == 1){
            $(".checkbox_item-box").addClass("active")
        }else{
            $(".checkbox_item-box").removeClass("active")
        }
       });

    $(".j-checkbox_item").on("click",function(){
     $(".checkbox_item-box").addClass("active")
    });
    $(".checkbox_item-1").on("click",function(){
        $(".checkbox_item-box").removeClass("active")
    });

    /**
	 * 搜索商品
	 */
	function searchGoods()
	{
		var form = $("#group_buy_form");
		var cat_id   = form.find("input[name='category_id']").val();
		var brand_id = form.find("input[name='brand_id']").val();
		var keyword  = form.find("input[name='keyword']").val();
		var ru_id = form.find("input[name='ru_id']").val();
		$.post("{url('bargain/admin/searchgoods')}", {cat_id:cat_id,brand_id:brand_id,keyword:keyword}, function(data){
             searchGoodsResponse(data);
        }, 'json');
	}

	function searchGoodsResponse(result)
	{
		$("#goods_id").children("ul").find("li").remove();

		var goods = result.content;
		if (goods)
		{
			for (i = 0; i < goods.length; i++)
			{
				$("#goods_id").children("ul").append("<li><i class='sc_icon sc_icon_no'></i><a href='javascript:;' data-value='"+goods[i].goods_id+"' class='ftx-01' onclick='goodsInfo("+goods[i].goods_id+")'>"+goods[i].goods_name+"</a><input type='hidden' name='user_search[]' value='"+goods[i].value+"'></li>")
			}
		}
	}
    var goodsId = $("input[name='bargain_goods_id']").val();

    goodsInfo(goodsId);

    /**
     * 获取选中商品详情
     */
    function goodsInfo(goodsId)
    {
        if(goodsId){
            $.post("{url('bargain/admin/goodsinfo')}", {goods_id:goodsId}, function(data){

                $("#goods_price").val(data.shop_price);
                document.getElementById('tbody-goodsAttr').innerHTML = data.goods_attribute;
                //设置属性表格
                set_attribute_table(goodsId);

            }, 'json');
        }else{
            return false;
        }

    }


    //设置属性表格
    function set_attribute_table(goodsId)
    {

        var attr_id_arr = [];
        var attr_value_arr = [];
        var attrId = $("#tbody-goodsAttr").find("input[type=checkbox][data-type=attr_id]:checked");
        var attrValue = attrId.siblings("input[type=checkbox][data-type=attr_value]");
        var bargainId = $("input[name='id']").val();//活动id
        attrId.each(function(){
            attr_id_arr.push($(this).val());
        });

        attrValue.each(function(){

            //过滤ajax传值加号问题
            var dataVal = $(this).val();
            dataVal = dataVal.replace(/\+/g, "%2B");
            dataVal = dataVal.replace(/\&/g, "%26");
            attr_value_arr.push(dataVal);
        });

        $.post("{url('bargain/admin/setattributetable')}", {bargain_id:bargainId,goods_id:goodsId,attr_id:attr_id_arr,attr_value:attr_value_arr}, function(data){
            if(data.content){
                 $("#attribute_table").html(data.content);
            }else{
                $(".goods_price").addClass("active");
                $(".target_price").addClass("active");
            }
        }, 'json');

    }

	// 选择品牌
	$('input[name="brand_name"]').click(function(){
		$(".brand-select-container").hide();
		$(this).parents(".selection").next(".brand-select-container").show();
		//$(".brand-list").perfectScrollbar("destroy");
		//$(".brand-list").perfectScrollbar();
    });

	/* AJAX选择品牌 */
    // 根据首字母查询
    $('.letter').find('a[data-letter]').click(function(){
		var goods_id = $("input[name=goods_id]").val();
		var letter = $(this).attr('data-letter');
		$(".brand-not strong").html(letter);
		$.post("{url('bargain/admin/searchbrand')}", {goods_id:goods_id,letter:letter}, function(result){
			if(result.content){
				$(".brand-list").html(result.content);
				$(".brand-not").hide();
			}else{
				$(".brand-list").html("");
				$(".brand-not").show();
			}
			//$(".brand-list").perfectScrollbar("destroy");
			//$(".brand-list").perfectScrollbar();
		}, 'json')
    });


    // 根据关键字查询品牌
    $('.b_search').find('a').click(function(){
		var goods_id = $("input[name=goods_id]").val();
		var keyword = $(this).prev().val();
		$(".brand-not strong").html(keyword);
		$.post("{url('bargain/admin/searchbrand')}", {goods_id:goods_id,keyword:keyword}, function(result){
			if(result.content){
				$(".brand-list").html(result.content);
				$(".brand-not").hide();
			}else{
				$(".brand-list").html("");
				$(".brand-not").show();
			}
			//$(".brand-list").perfectScrollbar("destroy");
			//$(".brand-list").perfectScrollbar();
		}, 'json')
    });

    // 选择品牌
    $('.brand-list').on('click', 'li', function(){
        $(this).parents('.brand-select-container').prev().find('input[data-filter=brand_id]').val($(this).data('id'));
        $(this).parents('.brand-select-container').prev().find('input[data-filter=brand_name]').val($(this).data('name'));
        $('.brand-select-container').hide();
    });

	jQuery.category = function(){
		$('.selection input[name="category_name"]').click(function(){
		$(this).parents(".selection").next('.select-container').show();
	});

	/*点击分类获取下级分类列表*/
	$(document).on('click', '.select-list li', function(){
		var obj = $(this);
		var cat_id = $(this).data('cid');
		$.post("{url('bargain/admin/filtercategory')}", {cat_id:cat_id}, function(result){
			if(result.content){
				obj.parents(".categorySelect").find("input[data-filter=cat_name]").val(result.cat_nav); //修改cat_name
				obj.parents(".select-container").html(result.content);
				//$(".select-list").perfectScrollbar("destroy");
				//$(".select-list").perfectScrollbar();
			}
		}, 'json');
		obj.parents(".categorySelect").find("input[data-filter=cat_id]").val(cat_id); //修改cat_id

		var cat_level = obj.parents(".categorySelect").find(".select-top a").length; //获取分类级别
		if(cat_level >= 3){
			$('.categorySelect .select-container').hide();
		}
	});

	//点击a标签返回所选分类 by wu
	$(document).on('click', '.select-top a', function(){
		var obj = $(this);
		var cat_id = $(this).data('cid');
		//$.jqueryAjax('get_ajax_content.php', 'act=filter_category&cat_id='+cat_id, function(data){
		$.post("{url('bargain/admin/filtercategory')}", {cat_id:cat_id}, function(result){
			if(result.content){
				obj.parents(".categorySelect").find("input[data-filter=cat_name]").val(result.cat_nav); //修改cat_name
				obj.parents(".select-container").html(result.content);
				//$(".select-list").perfectScrollbar("destroy");
				//$(".select-list").perfectScrollbar();
			}
		}, 'json');
		obj.parents(".categorySelect").find("input[data-filter=cat_id]").val(cat_id); //修改cat_id
		//obj.parents(".categorySelect").find("input[data-filter=cat_id]").val(cat_id); //修改cat_id
	});
	/*分类搜索的下拉列表end*/
}


//div仿select下拉选框 start
	$(document).on("click",".imitate_select .cite",function(){
		$(".imitate_select ul").hide();
		$(this).parents(".imitate_select").find("ul").show();
		//$(this).siblings("ul").perfectScrollbar("destroy");
		//$(this).siblings("ul").perfectScrollbar();
	});

	$(document).on("click",".imitate_select li  a",function(){
		var _this = $(this);
		var val = _this.data('value');
		var text = _this.html();
		_this.parents(".imitate_select").find(".cite").html(text);
		_this.parents(".imitate_select").find("input[type=hidden]").val(val);
		_this.parents(".imitate_select").find("ul").hide();
	});
//div仿select下拉选框 end

$(document).click(function(e){
	/*
	**点击空白处隐藏展开框
	*/

	//会员搜索
	if(e.target.id !='user_name' && !$(e.target).parents("div").is(".select-container")){
		$('.selection_select .select-container').hide();
	}
	//品牌
	if(e.target.id !='brand_name' && !$(e.target).parents("div").is(".brand-select-container")){
		$('.brand-select-container').hide();
		$('.brandSelect .brand-select-container').hide();
	}
	//分类
	if(e.target.id !='category_name' && !$(e.target).parents("div").is(".select-container")){
		$('.categorySelect .select-container').hide();
	}
	//仿select
	if(e.target.className !='cite' && !$(e.target).parents("div").is(".imitate_select")){
		$('.imitate_select ul').hide();
	}
	//日期选择插件
	if(!$(e.target).parent().hasClass("text_time")){
		$(".iframe_body").removeClass("relative");
	}
});

	//select下拉默认值赋值
	$('.imitate_select').each(function()
	{
		var sel_this = $(this)
		var val = sel_this.children('input[type=hidden]').val();
		sel_this.find('a').each(function(){
			if($(this).attr('data-value') == val){
				sel_this.children('.cite').html($(this).html());
			}
		})
	});

//分类选择
	$.category();


    $(".categorySelect .select-container ul li").click(function(){
    	var cate=$(this).attr("data-cname")
    	$("#category_name").val(cate)
    })
</script>
{include file="admin/footer"}
